import random
import logging
import re
from datetime import datetime
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes

# ========== –¢–í–û–ò –î–ê–ù–ù–´–ï ==========
YOUR_USER_ID = 8449323467  # –¢–í–û–ô ID (–ø–æ–º–µ–Ω—è–π)
BOT_TOKEN = "8580195855:AAHpKyKKS_ResHZRyuBRE6Oe9yD-SVsRQSQ"  # –¢–í–û–ô –¢–û–ö–ï–ù
# ================================

logging.basicConfig(level=logging.INFO)

# ========== –†–ê–°–®–ò–†–ï–ù–ù–ê–Ø –ë–ê–ó–ê –ó–ù–ê–ù–ò–ô ==========
class BotKnowledge:
    def __init__(self):
        self.greetings = {
            "formal": [
                "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –í–∞—Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏—á–Ω—ã–π —Å–µ–∫—Ä–µ—Ç–∞—Ä—å –ì–∞–π—Ä–∞—Ç–∂–æ–Ω–∞. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?",
                "–î–æ–±—Ä—ã–π –¥–µ–Ω—å! –Ø –ø–æ–º–æ—â–Ω–∏–∫ –ì–∞–π—Ä–∞—Ç–∂–æ–Ω–∞. –†–∞–¥ –≤–∞—Å —Å–ª—ã—à–∞—Ç—å!",
                "–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é! –ì–∞–π—Ä–∞—Ç–∂–æ–Ω –ø–æ—Ä—É—á–∏–ª –º–Ω–µ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è.",
            ],
            "casual": [
                "–ü—Ä–∏–≤–µ—Ç! –Ø —Å–µ–∫—Ä–µ—Ç–∞—Ä—å –ì–∞–π—Ä–∞—Ç–∂–æ–Ω–∞. –ö–∞–∫ –¥–µ–ª–∞?",
                "–ó–¥–∞—Ä–æ–≤–∞! –ì–∞–π—Ä–∞—Ç–∂–æ–Ω –∑–∞–Ω—è—Ç, –Ω–æ —è —Ç—É—Ç –∫–∞–∫ —Ç—É—Ç!",
                "–û, –ø—Ä–∏–≤–µ—Ç! –ì–∞–π—Ä–∞—Ç–∂–æ–Ω —Å–∫–æ—Ä–æ –ø–æ–¥–æ–π–¥–µ—Ç, –∞ –ø–æ–∫–∞ –ø–æ–±–æ–ª—Ç–∞–µ–º?",
            ],
            "funny": [
                "–ô–æ! –ì–∞–π—Ä–∞—Ç–∂–æ–Ω –º–µ–Ω—è –æ—Å—Ç–∞–≤–∏–ª –∑–∞ –≥–ª–∞–≤–Ω–æ–≥–æ. –ß–µ–≥–æ —Ö–æ—Ç–µ–ª–∏? üòé",
                "–°–ª—É—à–∞—é –≤–∞—Å –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ! –ì–∞–π—Ä–∞—Ç–∂–æ–Ω –≤ –æ—Ç–∫–ª—é—á–∫–µ (–∫–æ–¥–∏—Ç), —è –Ω–∞ —Å–≤—è–∑–∏!",
                "–ê–ª–ª–æ! –≠—Ç–æ —Å–µ–∫—Ä–µ—Ç–∞—Ä—å –ì–∞–π—Ä–∞—Ç–∂–æ–Ω–∞. –•–æ–∑—è–∏–Ω —Å–ø–∏—Ç, —è –±–æ–¥—Ä—Å—Ç–≤—É—é!",
            ]
        }
        
        self.jokes = {
            "programming": [
                "–ì–∞–π—Ä–∞—Ç–∂–æ–Ω –≤—á–µ—Ä–∞ –Ω–∞–ø–∏—Å–∞–ª –∫–æ–¥ —Å –ø–µ—Ä–≤–æ–≥–æ —Ä–∞–∑–∞. –≠—Ç–æ –±—ã–ª–æ –Ω–∞—Å—Ç–æ–ª—å–∫–æ —ç–ø–∏—á–Ω–æ, —á—Ç–æ –¥–∞–∂–µ –∫–æ—Ç —É–¥–∏–≤–∏–ª—Å—è!",
                "–ü–æ—á–µ–º—É –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç—ã –Ω–µ –∏–≥—Ä–∞—é—Ç –≤ —Ñ—É—Ç–±–æ–ª? –ë–æ—è—Ç—Å—è, —á—Ç–æ –º—è—á –æ–∫–∞–∂–µ—Ç—Å—è —Å –±–∞–≥–∞–º–∏!",
                "–°–∫–æ–ª—å–∫–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–æ–≤ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –∑–∞–º–µ–Ω–∏—Ç—å –ª–∞–º–ø–æ—á–∫—É? –ù–∏ –æ–¥–Ω–æ–≥–æ, —ç—Ç–æ hardware –ø—Ä–æ–±–ª–µ–º–∞!",
                "–ì–∞–π—Ä–∞—Ç–∂–æ–Ω –≥–æ–≤–æ—Ä–∏—Ç, —á—Ç–æ –µ–≥–æ –∫–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç. –û–±—ã—á–Ω–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç '–∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫' üòÑ",
            ],
            "life": [
                "–ò–¥–µ—Ç –ì–∞–π—Ä–∞—Ç–∂–æ–Ω –ø–æ —É–ª–∏—Ü–µ, –≤–∏–¥–∏—Ç ‚Äî –ª–µ–∂–∏—Ç —Ä–æ—É—Ç–µ—Ä. –î—É–º–∞–µ—Ç: '–ù–∞–≤–µ—Ä–Ω–æ–µ, Wi-Fi –ø–æ—Ç–µ—Ä—è–ª'",
                "–ó–Ω–∞–µ—Ç–µ, —á–µ–º –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç –æ—Ç –æ–±—ã—á–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞? –ü—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç –∑–Ω–∞–µ—Ç, —á—Ç–æ 'ctrl+Z' —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ –≤–µ–∑–¥–µ!",
                "–ì–∞–π—Ä–∞—Ç–∂–æ–Ω —Å–µ–≥–æ–¥–Ω—è –ø—ã—Ç–∞–ª—Å—è –≤—ã–π—Ç–∏ –∏–∑ –¥–æ–º–∞ —á–µ—Ä–µ–∑ –∑–µ—Ä–∫–∞–ª–æ. –î—É–º–∞–ª, —ç—Ç–æ –ø–æ—Ä—Ç–∞–ª –≤ –¥—Ä—É–≥–æ–π –º–∏—Ä!",
            ],
            "geek": [
                "–ö–∞–∫ —Ä–∞—Å—Å–º–µ—à–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–∞? –†–∞—Å—Å–∫–∞–∑–∞—Ç—å –µ–º—É —à—É—Ç–∫—É –ø—Ä–æ 01.01.1970",
                "–ß—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç, –∫–æ–≥–¥–∞ –ø—Ä–æ—Å—ã–ø–∞–µ—Ç—Å—è? '01001110 01101111 01110111'",
                "–ì–∞–π—Ä–∞—Ç–∂–æ–Ω –Ω–µ —Å–ø–∏—Ç, –æ–Ω –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è!",
            ]
        }
        
        self.facts = [
            "–ó–Ω–∞–µ—Ç–µ –ª–∏ –≤—ã, —á—Ç–æ –ì–∞–π—Ä–∞—Ç–∂–æ–Ω –æ–¥–Ω–∞–∂–¥—ã –Ω–∞–ø–∏—Å–∞–ª –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–±–æ—Ç–∞–ª –±–µ–∑ –µ–¥–∏–Ω–æ–≥–æ –±–∞–≥–∞? –≠—Ç–æ –±—ã–ª–æ 29 —Ñ–µ–≤—Ä–∞–ª—è –≤ –≤–∏—Å–æ–∫–æ—Å–Ω—ã–π –≥–æ–¥!",
            "–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ñ–∞–∫—Ç: –ì–∞–π—Ä–∞—Ç–∂–æ–Ω –ø—å–µ—Ç –∫–æ—Ñ–µ —Ç–æ–ª—å–∫–æ –≤ –∫–æ–Ω—Å–æ–ª–∏. –ë–µ–∑ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞!",
            "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: 90% –≤—Ä–µ–º–µ–Ω–∏ –ì–∞–π—Ä–∞—Ç–∂–æ–Ω –¥—É–º–∞–µ—Ç, 10% ‚Äî –ø–∏—à–µ—Ç –∫–æ–¥. –ù–æ –∫–æ–¥ –ø–æ–ª—É—á–∞–µ—Ç—Å—è –Ω–∞ –≤—Å–µ 100%!",
            "–ì–∞–π—Ä–∞—Ç–∂–æ–Ω —É—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç, —á—Ç–æ –µ–≥–æ –∫–æ—Ç –ª—É—á—à–µ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç –∫–æ–¥, —á–µ–º –ª—é–±–æ–π QA-–∏–Ω–∂–µ–Ω–µ—Ä!",
        ]
        
        self.problems = {
            "tech": [
                "–û–ø–∏—à–∏—Ç–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –ø—Ä–æ–±–ª–µ–º—É –ø–æ–¥—Ä–æ–±–Ω–µ–µ. –ì–∞–π—Ä–∞—Ç–∂–æ–Ω —Ä–∞–∑–±–∏—Ä–∞–µ—Ç—Å—è –≤: Python, JavaScript, –±–∞–≥–∞—Ö, –∫–æ—Ñ–µ –∏ –∫–æ—Ç–∞—Ö.",
                "–≠—Ç–æ –ø–æ—Ö–æ–∂–µ –Ω–∞ –±–∞–≥ –≤ –º–∞—Ç—Ä–∏—Ü–µ. –ì–∞–π—Ä–∞—Ç–∂–æ–Ω –ø–æ—Å–º–æ—Ç—Ä–∏—Ç, –∫–∞–∫ –æ—Å–≤–æ–±–æ–¥–∏—Ç—Å—è!",
                "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞? –ì–∞–π—Ä–∞—Ç–∂–æ–Ω —Å–∫–∞–∑–∞–ª: '–ü–æ–ø—Ä–æ–±—É–π –≤—ã–∫–ª—é—á–∏—Ç—å –∏ –≤–∫–ª—é—á–∏—Ç—å –æ–±—Ä–∞—Ç–Ω–æ' üòâ",
            ],
            "personal": [
                "–ü–æ–Ω–∏–º–∞—é. –ì–∞–π—Ä–∞—Ç–∂–æ–Ω —Ç–æ–∂–µ —á–∞—Å—Ç–æ —Å —ç—Ç–∏–º —Å—Ç–∞–ª–∫–∏–≤–∞–µ—Ç—Å—è. –û–Ω –ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç!",
                "–°–ª–æ–∂–Ω—ã–π –≤–æ–ø—Ä–æ—Å. –ì–∞–π—Ä–∞—Ç–∂–æ–Ω –æ–±–µ—â–∞–ª —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –ª–∏—á–Ω–æ.",
                "–Ø –∑–∞–ø–∏—Å–∞–ª –≤–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ. –ì–∞–π—Ä–∞—Ç–∂–æ–Ω –æ—Ç–≤–µ—Ç–∏—Ç, –∫–∞–∫ —Ç–æ–ª—å–∫–æ –¥–æ–ø—å–µ—Ç –∫–æ—Ñ–µ (—ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è ‚òï)",
            ],
            "urgent": [
                "–°—Ä–æ—á–Ω–æ? –•–æ—Ä–æ—à–æ, —è –ø–µ—Ä–µ–¥–∞–º –ì–∞–π—Ä–∞—Ç–∂–æ–Ω—É –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å!",
                "–ü–æ–Ω—è–ª, –≤–∞–∂–Ω–æ. –ì–∞–π—Ä–∞—Ç–∂–æ–Ω—É —É–∂–µ –ª–µ—Ç–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω!",
                "–û—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ '–í–∞–∂–Ω–æ'. –ì–∞–π—Ä–∞—Ç–∂–æ–Ω —Å–∫–æ—Ä–æ —Å–≤—è–∂–µ—Ç—Å—è!",
            ]
        }
        
        self.farewells = [
            "–î–æ —Å–≤–∏–¥–∞–Ω–∏—è! –ì–∞–π—Ä–∞—Ç–∂–æ–Ω—É –±—É–¥–µ—Ç –ø—Ä–∏—è—Ç–Ω–æ —É–∑–Ω–∞—Ç—å, —á—Ç–æ –≤—ã –∑–∞—Ö–æ–¥–∏–ª–∏!",
            "–í—Å–µ–≥–æ —Ö–æ—Ä–æ—à–µ–≥–æ! –ó–∞—Ö–æ–¥–∏—Ç–µ –µ—â–µ, –∫–æ–≥–¥–∞ –ì–∞–π—Ä–∞—Ç–∂–æ–Ω –æ—Å–≤–æ–±–æ–¥–∏—Ç—Å—è!",
            "–ü–æ–∫–∞! –ü–µ—Ä–µ–¥–∞–º –ì–∞–π—Ä–∞—Ç–∂–æ–Ω—É, —á—Ç–æ –≤—ã —Å–ø—Ä–∞—à–∏–≤–∞–ª–∏! üëã",
            "–î–æ —Å–≤—è–∑–∏! –ì–∞–π—Ä–∞—Ç–∂–æ–Ω –æ—Ç–≤–µ—Ç–∏—Ç, –∫–∞–∫ —Ç–æ–ª—å–∫–æ –≤—ã–π–¥–µ—Ç –∏–∑ –Ω–∏—Ä–≤–∞–Ω—ã (–∑–∞–∫–æ–Ω—á–∏—Ç –∫–æ–¥)",
        ]
        
        self.questions = {
            "who_are_you": [
                "–Ø –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç –ì–∞–π—Ä–∞—Ç–∂–æ–Ω–∞. –ù—É, –ø–æ—á—Ç–∏ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π. –õ–∞–¥–Ω–æ, –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≥—Ä–∞–º–º–∞ ü§ñ",
                "–Ø –ª–∏—á–Ω—ã–π —Å–µ–∫—Ä–µ—Ç–∞—Ä—å –ì–∞–π—Ä–∞—Ç–∂–æ–Ω–∞. –°–æ–∑–¥–∞–Ω, —á—Ç–æ–±—ã —Ä–∞–∑–≤–ª–µ–∫–∞—Ç—å –≥–æ—Å—Ç–µ–π, –ø–æ–∫–∞ —Ö–æ–∑—è–∏–Ω –∑–∞–Ω—è—Ç.",
                "–ú–µ–Ω—è –∑–æ–≤—É—Ç –°–µ–∫—Ä–µ—Ç–∞—Ä—å-–±–æ—Ç. –ú–æ—è –º–∏—Å—Å–∏—è ‚Äî –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—Ç—å –∞–Ω–µ–∫–¥–æ—Ç—ã!",
            ],
            "how_are_you": [
                "–£ –º–µ–Ω—è –≤—Å—ë –æ—Ç–ª–∏—á–Ω–æ! –ñ–¥—É, –∫–æ–≥–¥–∞ –ì–∞–π—Ä–∞—Ç–∂–æ–Ω –¥–æ–ø–∏—à–µ—Ç –∫–æ–¥ –∏ –º—ã –ø–æ–π–¥–µ–º –ø–∏—Ç—å –∫–æ—Ñ–µ!",
                "–†–∞–±–æ—Ç–∞—é 24/7 –±–µ–∑ –≤—ã—Ö–æ–¥–Ω—ã—Ö. –ù–æ –Ω–µ –∂–∞–ª—É—é—Å—å, –º–Ω–µ –∑–∞ —ç—Ç–æ –∫–æ–¥ –ø–ª–∞—Ç—è—Ç!",
                "–Ø –≤ –ø–æ—Ä—è–¥–∫–µ, —Å–ø–∞—Å–∏–±–æ! –°–∞–º –ì–∞–π—Ä–∞—Ç–∂–æ–Ω —Ç–æ–∂–µ –≤ –ø–æ—Ä—è–¥–∫–µ, –ø—Ä–æ—Å—Ç–æ –æ—á–µ–Ω—å –∑–∞–Ω—è—Ç.",
            ],
            "what_doing": [
                "–û—Ç–≤–µ—á–∞—é –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è, —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—é –∞–Ω–µ–∫–¥–æ—Ç—ã –∏ –∂–¥—É, –∫–æ–≥–¥–∞ –ì–∞–π—Ä–∞—Ç–∂–æ–Ω –æ—Å–≤–æ–±–æ–¥–∏—Ç—Å—è.",
                "–°–ª–µ–∂—É –∑–∞ –ø–æ—Ä—è–¥–∫–æ–º, –ø–æ–∫–∞ –ì–∞–π—Ä–∞—Ç–∂–æ–Ω –≤ –æ—Ç–∫–ª—é—á–∫–µ (–∫–æ–¥–∏—Ç). –ú–æ–≥—É –∏ –≤–∞–º –ø–æ–º–æ—á—å!",
                "–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è. –£ –≤–∞—Å –∫–∞–∫ —Ä–∞–∑ –≤—Ö–æ–¥—è—â–µ–µ, —è –æ—Ç–≤–µ—á–∞—é!",
            ],
            "where_gayratjon": [
                "–ì–∞–π—Ä–∞—Ç–∂–æ–Ω —Å–µ–π—á–∞—Å –∑–∞–Ω—è—Ç –≤–∞–∂–Ω—ã–º–∏ –¥–µ–ª–∞–º–∏. –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –ø–∏—à–µ—Ç –∫–æ–¥ –∏–ª–∏ —Å–ø–∏—Ç –ø–æ—Å–ª–µ –∫–æ–¥–∏–Ω–≥–∞.",
                "–ì–∞–π—Ä–∞—Ç–∂–æ–Ω –≤ –∑–æ–Ω–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ (—á–∏—Ç–∞–π: —Ä–∞–±–æ—Ç–∞–µ—Ç). –ë—É–¥–µ—Ç –ø–æ–∑–∂–µ!",
                "–•–æ–∑—è–∏–Ω –≤ —Ç–∞–Ω–∫–µ. –í —Å–º—ã—Å–ª–µ, –≤ –∫–æ–¥–µ. –û—Å–≤–æ–±–æ–¥–∏—Ç—Å—è ‚Äî –æ—Ç–≤–µ—Ç–∏—Ç!",
            ]
        }

# ========== –ö–õ–ê–°–° –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –î–ò–ê–õ–û–ì–ê–ú–ò ==========
class DialogManager:
    def __init__(self):
        self.knowledge = BotKnowledge()
        self.user_sessions = {}  # {user_id: {history: [], context: {}, last_activity: timestamp}}
        self.user_mood = {}  # {user_id: mood_score} –æ—Ç -5 –¥–æ 5
    
    def analyze_message(self, text):
        """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∏–Ω—Ç–µ–Ω—Ç—ã"""
        text_lower = text.lower()
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–æ–Ω —Å–æ–æ–±—â–µ–Ω–∏—è
        mood = 0
        if any(word in text_lower for word in ['–ø—Ä–∏–≤–µ—Ç', '–∑–¥—Ä–∞–≤—Å—Ç–≤', '–¥–æ–±—Ä']):
            mood += 1
        if any(word in text_lower for word in ['—Å–ø–∞—Å–∏–±', '–±–ª–∞–≥–æ–¥–∞—Ä']):
            mood += 2
        if any(word in text_lower for word in ['–æ—Ç–ª–∏—á–Ω', '—Å—É–ø–µ—Ä', '–∫—Ä—É—Ç–æ']):
            mood += 1
        if any(word in text_lower for word in ['–ø–ª–æ—Ö', '—É–∂–∞—Å–Ω', '–∫–æ—à–º–∞—Ä']):
            mood -= 2
        if any(word in text_lower for word in ['–Ω–∞–¥–æ–µ–ª', '–æ—Ç—Å—Ç–∞–Ω—å', '–¥—É—Ä–∞–∫']):
            mood -= 3
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–º—É
        topics = []
        if any(word in text_lower for word in ['–∫–æ–º–ø', '–Ω–æ—É—Ç', '–ø—Ä–æ–≥', '–∫–æ–¥', '–±–∞–≥', '–æ—à–∏–±–∫']):
            topics.append('tech')
        if any(word in text_lower for word in ['—Ä–∞–±–æ—Ç', '—É—Å—Ç–∞–ª', '–¥–µ–¥–ª–∞–π–Ω']):
            topics.append('work')
        if any(word in text_lower for word in ['–∂–µ–Ω', '–¥–µ–≤—É—à–∫', '–ª—é–±–æ–≤', '–æ—Ç–Ω–æ—à']):
            topics.append('personal')
        if any(word in text_lower for word in ['–∞–Ω–µ–∫–¥–æ—Ç', '—à—É—Ç–∫', '—Å–º–µ—à–Ω']):
            topics.append('humor')
        
        return {
            'mood': mood,
            'topics': topics,
            'has_question': '?' in text,
            'length': len(text),
            'words': len(text.split())
        }
    
    def choose_response_style(self, user_id, analysis):
        """–í—ã–±–∏—Ä–∞–µ—Ç —Å—Ç–∏–ª—å –æ—Ç–≤–µ—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∞–Ω–∞–ª–∏–∑–∞"""
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if user_id not in self.user_mood:
            self.user_mood[user_id] = 0
        
        self.user_mood[user_id] += analysis['mood']
        self.user_mood[user_id] = max(-5, min(5, self.user_mood[user_id]))
        
        mood = self.user_mood[user_id]
        
        # –í—ã–±–∏—Ä–∞–µ–º —Å—Ç–∏–ª—å –æ—Ç–≤–µ—Ç–∞
        if mood <= -3:
            style = 'serious'  # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–ª–æ–π, –æ—Ç–≤–µ—á–∞–µ–º —Å–µ—Ä—å–µ–∑–Ω–æ
        elif mood >= 3:
            style = 'funny'    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–µ—Å–µ–ª—ã–π, —à—É—Ç–∏–º
        else:
            style = 'normal'   # –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º
        
        # –£—á–∏—Ç—ã–≤–∞–µ–º —Ç–µ–º—É
        if 'tech' in analysis['topics']:
            style = 'professional'
        elif 'humor' in analysis['topics']:
            style = 'funny'
        
        return style
    
    def generate_response(self, user_id, text, is_new_user=False):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Å–µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞"""
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        analysis = self.analyze_message(text)
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º —Å–µ—Å—Å–∏—é
        if user_id not in self.user_sessions:
            self.user_sessions[user_id] = {
                'history': [],
                'context': {},
                'first_seen': datetime.now(),
                'message_count': 0
            }
        
        session = self.user_sessions[user_id]
        session['message_count'] += 1
        session['history'].append({
            'text': text,
            'time': datetime.now(),
            'analysis': analysis
        })
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∏–ª—å –æ—Ç–≤–µ—Ç–∞
        style = self.choose_response_style(user_id, analysis)
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        if is_new_user or session['message_count'] == 1:
            # –ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            greeting_type = 'casual' if style == 'funny' else 'formal'
            greeting = random.choice(self.knowledge.greetings[greeting_type])
            
            if any(word in text.lower() for word in ['–∞–Ω–µ–∫–¥–æ—Ç', '—à—É—Ç–∫']):
                return f"{greeting}\n\n–î–µ—Ä–∂–∏—Ç–µ –∞–Ω–µ–∫–¥–æ—Ç: {random.choice(self.knowledge.jokes['programming'])}"
            return greeting
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏ –≤–æ–ø—Ä–æ—Å—ã
        text_lower = text.lower()
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        if any(word in text_lower for word in ['–∫—Ç–æ —Ç—ã', '—Ç—ã –∫—Ç–æ']):
            return random.choice(self.knowledge.questions['who_are_you'])
        
        if any(word in text_lower for word in ['–∫–∞–∫ –¥–µ–ª–∞', '–∫–∞–∫ —Ç—ã']):
            return random.choice(self.knowledge.questions['how_are_you'])
        
        if any(word in text_lower for word in ['–≥–¥–µ –≥–∞–π—Ä–∞—Ç–∂–æ–Ω', '—Ö–æ–∑—è–∏–Ω', '–≥–∞–π—Ä–∞—Ç–∂–æ–Ω –≥–¥–µ']):
            return random.choice(self.knowledge.questions['where_gayratjon'])
        
        if any(word in text_lower for word in ['—á—Ç–æ –¥–µ–ª–∞–µ—à—å', '—á–µ–º –∑–∞–Ω—è—Ç']):
            return random.choice(self.knowledge.questions['what_doing'])
        
        # –ó–∞–ø—Ä–æ—Å—ã –Ω–∞ –∞–Ω–µ–∫–¥–æ—Ç—ã
        if any(word in text_lower for word in ['–∞–Ω–µ–∫–¥–æ—Ç', '—à—É—Ç–∫', '—Å–º–µ—à–Ω', 'üòÇ', 'üòÑ']):
            if '–ø—Ä–æ–≥—Ä–∞–º–º' in text_lower or '–∫–æ–¥' in text_lower:
                return f"üíª –ê–Ω–µ–∫–¥–æ—Ç –ø—Ä–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–æ–≤:\n{random.choice(self.knowledge.jokes['programming'])}"
            elif '–∂–∏–∑–Ω' in text_lower:
                return f"üåü –ñ–∏–∑–Ω–µ–Ω–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è:\n{random.choice(self.knowledge.jokes['life'])}"
            else:
                joke_type = random.choice(list(self.knowledge.jokes.keys()))
                return f"üé≠ {random.choice(self.knowledge.jokes[joke_type])}"
        
        # –ó–∞–ø—Ä–æ—Å—ã —Ñ–∞–∫—Ç–æ–≤
        if any(word in text_lower for word in ['—Ñ–∞–∫—Ç', '–∏–Ω—Ç–µ—Ä–µ—Å–Ω', '–∑–Ω–∞–µ—à—å –ª–∏']):
            return f"üìö –ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ñ–∞–∫—Ç: {random.choice(self.knowledge.facts)}"
        
        # –ü—Ä–æ—â–∞–Ω–∏–µ
        if any(word in text_lower for word in ['–ø–æ–∫–∞', '–¥–æ —Å–≤–∏–¥–∞–Ω', '–ø—Ä–æ—â–∞–π', 'bye']):
            farewell = random.choice(self.knowledge.farewells)
            if session['message_count'] > 5:
                farewell += f" –ú—ã —Å –≤–∞–º–∏ —É–∂–µ {session['message_count']} —Å–æ–æ–±—â–µ–Ω–∏–π –æ–±–º–µ–Ω—è–ª–∏!"
            return farewell
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–±–ª–µ–º
        if any(word in text_lower for word in ['–ø—Ä–æ–±–ª–µ–º', '–ø–æ–º–æ–≥–∏', '–≤–æ–ø—Ä–æ—Å', '–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç']):
            if '—Å—Ä–æ—á–Ω' in text_lower or '–≤–∞–∂–Ω' in text_lower:
                return f"‚ö†Ô∏è {random.choice(self.knowledge.problems['urgent'])}"
            elif '–∫–æ–º–ø' in text_lower or '–ø—Ä–æ–≥' in text_lower:
                return f"üñ•Ô∏è {random.choice(self.knowledge.problems['tech'])}"
            else:
                return f"üìù {random.choice(self.knowledge.problems['personal'])}"
        
        # –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å
        if any(word in text_lower for word in ['—Å–ø–∞—Å–∏–±', '–±–ª–∞–≥–æ–¥–∞—Ä']):
            thanks = [
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞! –ì–∞–π—Ä–∞—Ç–∂–æ–Ω—É –±—É–¥–µ—Ç –ø—Ä–∏—è—Ç–Ω–æ, —á—Ç–æ –≤—ã –æ—Ü–µ–Ω–∏–ª–∏!",
                "–í—Å–µ–≥–¥–∞ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞! –û–±—Ä–∞—â–∞–π—Ç–µ—Å—å –µ—â–µ!",
                "–ù–∞ –∑–¥–æ—Ä–æ–≤—å–µ! –ì–∞–π—Ä–∞—Ç–∂–æ–Ω –ø—Ä–æ—Å–∏–ª –ø–µ—Ä–µ–¥–∞—Ç—å, —á—Ç–æ –≤—ã –º–æ–ª–æ–¥–µ—Ü!",
            ]
            return random.choice(thanks)
        
        # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–¥–æ—à–ª–æ, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç
        if analysis['has_question']:
            # –ù–∞ –≤–æ–ø—Ä–æ—Å—ã –æ—Ç–≤–µ—á–∞–µ–º –±–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ
            responses = [
                "–•–æ—Ä–æ—à–∏–π –≤–æ–ø—Ä–æ—Å! –Ø –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–¥–∞–º –µ–≥–æ –ì–∞–π—Ä–∞—Ç–∂–æ–Ω—É.",
                f"–í–æ–ø—Ä–æ—Å –ø–æ–Ω—è–ª. –ó–∞–ø–∏—Å–∞–ª: '{text[:50]}...'. –ì–∞–π—Ä–∞—Ç–∂–æ–Ω –æ—Ç–≤–µ—Ç–∏—Ç!",
                "–î—É–º–∞—é, –ì–∞–π—Ä–∞—Ç–∂–æ–Ω –ª—É—á—à–µ –æ—Ç–≤–µ—Ç–∏—Ç –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å –ª–∏—á–Ω–æ.",
            ]
        else:
            # –ü—Ä–æ—Å—Ç–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –¥–∏–∞–ª–æ–≥
            responses = [
                "–ü–æ–Ω—è–ª –≤–∞—Å. –ì–∞–π—Ä–∞—Ç–∂–æ–Ω—É –ø–µ—Ä–µ–¥–∞–º!",
                "–ó–∞–ø–∏—Å–∞–ª. –•–æ–∑—è–∏–Ω —Å–∫–æ—Ä–æ —Å–≤—è–∂–µ—Ç—Å—è!",
                "–û–∫–µ–π, —è –≤—Å—ë –∑–∞–ø–æ–º–Ω–∏–ª. –ì–∞–π—Ä–∞—Ç–∂–æ–Ω –æ—Ç–≤–µ—Ç–∏—Ç!",
                "–ü—Ä–∏–Ω—è—Ç–æ. –ñ–¥–µ–º –ì–∞–π—Ä–∞—Ç–∂–æ–Ω–∞ —Å –∫–æ—Ñ–µ!",
            ]
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–ª–∏–Ω—ã –¥–∏–∞–ª–æ–≥–∞
        if session['message_count'] > 10:
            responses.append("–ú—ã —Å –≤–∞–º–∏ —É–∂–µ —Å—Ç–∞—Ä—ã–µ –∑–Ω–∞–∫–æ–º—ã–µ! –ì–∞–π—Ä–∞—Ç–∂–æ–Ω –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç –ª–∏—á–Ω–æ!")
        
        return random.choice(responses)

# ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
dialog_manager = DialogManager()

# ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ==========
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /start"""
    user = update.effective_user
    user_id = user.id
    
    # –ï—Å–ª–∏ —ç—Ç–æ —Ö–æ–∑—è–∏–Ω
    if user.id == YOUR_USER_ID:
        await update.message.reply_text(
            "ü§µ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, —Ö–æ–∑—è–∏–Ω!\n\n"
            "–ö–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:\n"
            "/stats ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±—â–µ–Ω–∏—è\n"
            "/reset ‚Äî —Å–±—Ä–æ—Å–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–æ–≤\n"
            "/mood ‚Äî –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n"
            "/broadcast [—Å–æ–æ–±—â–µ–Ω–∏–µ] ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!)"
        )
        return
    
    # –ï—Å–ª–∏ –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    response = dialog_manager.generate_response(user_id, "/start", is_new_user=True)
    await update.message.reply_text(response)
    
    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ö–æ–∑—è–∏–Ω—É
    try:
        await context.bot.send_message(
            chat_id=YOUR_USER_ID,
            text=f"üÜï –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user.first_name} (@{user.username})\nID: {user_id}"
        )
    except:
        pass

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    user = update.effective_user
    chat_id = update.effective_chat.id
    text = update.message.text
    user_id = user.id
    
    # –ï—Å–ª–∏ –ø–∏—à–µ—Ç —Ö–æ–∑—è–∏–Ω
    if user.id == YOUR_USER_ID:
        # –ö–æ–º–∞–Ω–¥—ã —Ö–æ–∑—è–∏–Ω–∞
        if text.startswith('/stats'):
            total_users = len(dialog_manager.user_sessions)
            total_msgs = sum(s['message_count'] for s in dialog_manager.user_sessions.values())
            active_today = sum(1 for s in dialog_manager.user_sessions.values() 
                             if (datetime.now() - s.get('last_seen', datetime.now())).seconds < 86400)
            
            await update.message.reply_text(
                f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞:\n"
                f"üë• –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {total_users}\n"
                f"üí¨ –í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {total_msgs}\n"
                f"üì± –ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ–≥–æ–¥–Ω—è: {active_today}\n"
                f"üòä –°—Ä–µ–¥–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: {sum(dialog_manager.user_mood.values())/max(1, len(dialog_manager.user_mood)):.1f}"
            )
            return
            
        elif text.startswith('/reset'):
            dialog_manager.user_sessions = {}
            dialog_manager.user_mood = {}
            await update.message.reply_text("üóëÔ∏è –ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –¥–∏–∞–ª–æ–≥–æ–≤ —Å–±—Ä–æ—à–µ–Ω–∞!")
            return
            
        elif text.startswith('/mood'):
            mood_report = "–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:\n"
            for uid, mood in list(dialog_manager.user_mood.items())[:10]:  # –ü–æ–∫–∞–∂–µ–º –ø–µ—Ä–≤—ã—Ö 10
                mood_emoji = "üòä" if mood > 2 else "üòê" if mood > -2 else "üò†"
                mood_report += f"{uid}: {mood} {mood_emoji}\n"
            await update.message.reply_text(mood_report)
            return
        
        # –ï—Å–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø–∏—à–µ—Ç —Ö–æ–∑—è–∏–Ω –≤ —á–∞—Ç —Å –±–æ—Ç–æ–º
        await update.message.reply_text("‚úÖ –°–ª—É—à–∞—é—Å—å, —Ö–æ–∑—è–∏–Ω!")
        return
    
    # –ï—Å–ª–∏ –ø–∏—à–µ—Ç –æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    response = dialog_manager.generate_response(user_id, text)
    await update.message.reply_text(response)
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    if user_id in dialog_manager.user_sessions:
        dialog_manager.user_sessions[user_id]['last_seen'] = datetime.now()
    
    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ö–æ–∑—è–∏–Ω—É (–Ω–µ —á–∞—â–µ —Ä–∞–∑–∞ –≤ –º–∏–Ω—É—Ç—É –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
    import time
    last_notify = context.bot_data.get(f'last_notify_{user_id}', 0)
    if time.time() - last_notify > 60:  # –ù–µ —á–∞—â–µ —Ä–∞–∑–∞ –≤ –º–∏–Ω—É—Ç—É
        context.bot_data[f'last_notify_{user_id}'] = time.time()
        try:
            await context.bot.send_message(
                chat_id=YOUR_USER_ID,
                text=f"üì© {user.first_name}: {text[:100]}\n\n(–Ø –æ—Ç–≤–µ—Ç–∏–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)"
            )
        except:
            pass

async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫"""
    logging.error(f"–û—à–∏–±–∫–∞: {context.error}")

if __name__ == "__main__":
    print("ü§µ –ó–∞–ø—É—Å–∫–∞—é —É–º–Ω–æ–≥–æ —Å–µ–∫—Ä–µ—Ç–∞—Ä—è –ì–∞–π—Ä–∞—Ç–∂–æ–Ω–∞...")
    
    app = Application.builder().token(BOT_TOKEN).build()
    
    # –ö–æ–º–∞–Ω–¥—ã
    app.add_handler(CommandHandler("start", start))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
    app.add_error_handler(error_handler)
    
    print("‚úÖ –£–º–Ω—ã–π —Å–µ–∫—Ä–µ—Ç–∞—Ä—å –Ω–∞ –ø–æ—Å—Ç—É!")
    print("üì± –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –≥–æ—Ç–æ–≤ –∫ –¥–∏–∞–ª–æ–≥–∞–º!")
    
    app.run_polling()
